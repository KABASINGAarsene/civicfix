<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CivicFix</title>
    <link rel="icon" type="image/jpeg" href="icons/civicfix-favicon.jpg">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #718096;
            font-weight: 500;
        }
        
        .admin-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        /* Action buttons + filter bar */
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .admin-filter-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .admin-filter-controls select {
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: 1px solid #cbd5e0;
            background: #ffffff;
            font-size: 0.9rem;
            color: #4a5568;
            outline: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            min-width: 140px;
            cursor: pointer;
        }

        .admin-filter-controls select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                align-items: flex-start;
            }

            .admin-filter-controls {
                width: 100%;
                justify-content: flex-start;
            }

            .admin-filter-controls select {
                flex: 1 1 100%;
                min-width: 0;
            }
        }
        
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(102, 126, 234, 0.4);
        }
        
        .action-btn.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .issues-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            font-weight: 600;
        }
        
        .issue-row {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            display: grid;
            grid-template-columns: 1fr 150px 120px 150px 200px;
            gap: 1rem;
            align-items: center;
        }
        
        .issue-row:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }
        
        .priority-high {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .priority-medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .priority-low {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .nav-user-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .profile-btn {
            background: transparent;
            color: #4a5568;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .profile-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .welcome-text {
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .admin-logout {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .admin-logout:hover {
            background: #c53030;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* Override for issue details modal */
        .modal-content.issue-details-content {
            max-width: 900px !important;
            width: 95% !important;
            max-height: 80vh !important;
            margin: 10vh auto !important;
            position: relative !important;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 12px 12px 0 0;
            flex-shrink: 0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 1.25rem;
        }
        
        .modal-header .close {
            font-size: 2rem;
            font-weight: bold;
            color: #718096;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            border-radius: 50%;
            transition: all 0.2s;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-header .close:hover {
            background: #f7fafc;
            color: #e53e3e;
            transform: scale(1.1);
        }
        
        .close {
            color: #a0aec0;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: #e53e3e;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .profile-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section h4 {
            color: #2d3748;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
            background: #fafafa;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input[readonly] {
            background-color: #f7fafc;
            color: #718096;
            cursor: not-allowed;
        }
        
        .form-group small {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: block;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        /* Make navbar sticky too */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Issues Table Styling */
        .issues-table-header {
            display: flex;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            margin-bottom: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .issue-row {
            display: flex;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            align-items: flex-start;
            margin: 0;
        }
        
        .issue-row:first-of-type {
            border-top: none;
        }
        
        .issue-row:last-child {
            border-radius: 0 0 8px 8px;
            border-bottom: none;
        }
        
        .issue-row:hover {
            background: #f7fafc;
        }
        
        #issues-container {
            border-radius: 8px;
            overflow: visible;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        @media (max-width: 768px) {
            .profile-form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
            
            .issues-table-header,
            .issue-row {
                flex-direction: column;
                text-align: left !important;
            }
            
            .issues-table-header div,
            .issue-row div {
                flex: none !important;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Issue Details Modal Styling - handled by override above */
        
        .modal-body {
            padding: 1.5rem;
            max-height: calc(80vh - 100px); /* Account for header */
            overflow-y: auto;
        }
        
        .issue-info-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        
        .issue-basic-info h4 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        
        .issue-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .issue-meta p {
            margin: 0.25rem 0;
            color: #4a5568;
        }
        
        .admin-action-section {
            background: #fff;
            border: 2px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        
        .admin-action-section h5 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .action-form .form-group {
            margin-bottom: 1rem;
        }
        
        .action-form label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }
        
        .status-dropdown {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }
        
        .status-dropdown:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .admin-comment-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }
        
        .admin-comment-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-save-status {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-save-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .timeline-section, .comments-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .timeline-section h5, .comments-section h5 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .timeline-container, .comments-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timeline-item {
            background: white;
            padding: 1rem;
            border-left: 4px solid #667eea;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .timeline-item .timeline-date {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9rem;
        }
        
        .timeline-item .timeline-action {
            color: #2d3748;
            margin: 0.25rem 0;
        }
        
        .timeline-item .timeline-comment {
            color: #718096;
            font-style: italic;
            margin-top: 0.5rem;
        }
        
        .comment-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .comment-item .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .comment-item .comment-author {
            font-weight: 600;
            color: #2d3748;
        }
        
        .comment-item .comment-date {
            font-size: 0.85rem;
            color: #718096;
        }
        
        .comment-item .comment-text {
            color: #4a5568;
            line-height: 1.5;
        }
        
        .timeline-loading, .comments-loading {
            text-align: center;
            color: #718096;
            padding: 2rem;
            font-style: italic;
        }
        
        /* Location Details Styling */
        .location-details {
            background: #fff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .location-details h5 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .location-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .location-admin, .location-specific {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .location-admin h6, .location-specific h6 {
            color: #4a5568;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .location-description {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .location-description h6 {
            color: #4a5568;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        /* Photo Section Styling */
        .photo-section {
            background: #fff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .photo-section h5 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .photo-container {
            text-align: center;
        }
        
        .issue-photo {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .issue-photo:hover {
            transform: scale(1.02);
        }
        
        /* Status Badge Styling */
        .status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        
        .status.open {
            background: #fed7d7;
            color: #c53030;
        }
        
        .status.in-progress {
            background: #feebc8;
            color: #dd6b20;
        }
        
        .status.resolved {
            background: #c6f6d5;
            color: #38a169;
        }

        @media (max-width: 768px) {
            .location-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-content.issue-details-content {
                width: 98% !important;
                margin: 5vh auto !important;
                max-height: 85vh !important;
            }
            
            .modal-body {
                padding: 1rem;
                max-height: calc(85vh - 80px);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">CivicFix Admin Dashboard</h1>
            <div class="nav-links">
                <div class="nav-user-section">
                    <button id="profile-btn" class="profile-btn">Profile</button>
                    <span id="admin-info" class="welcome-text"></span>
                    <button id="admin-logout-btn" class="admin-logout">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="admin-header">
            <h2>Administrative Dashboard</h2>
            <p>Manage community infrastructure issues and coordinate responses</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-issues" style="color: #667eea;">0</div>
                <div class="stat-label">Total Issues</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="open-issues" style="color: #e74c3c;">0</div>
                <div class="stat-label">Open Issues</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="in-progress-issues" style="color: #f39c12;">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="resolved-issues" style="color: #27ae60;">0</div>
                <div class="stat-label">Resolved</div>
            </div>
        </div>

        <!-- Action Buttons + Filters -->
        <div class="action-buttons">
            <button class="action-btn urgent" onclick="filterIssues('urgent')">
                Urgent Issues
            </button>
            <button class="action-btn" onclick="filterIssues('all')">
                All Issues
            </button>

            <!-- Simple admin filters: status, category, votes -->
            <div class="admin-filter-controls">
                <select id="admin-status-filter" onchange="adminDashboard.applyFiltersFromControls()">
                    <option value="">All Statuses</option>
                    <option value="open">Open</option>
                    <option value="in-progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                </select>
                <select id="admin-category-filter" onchange="adminDashboard.applyFiltersFromControls()">
                    <option value="">All Categories</option>
                    <option value="Roads">Roads</option>
                    <option value="Lighting">Street Lighting</option>
                    <option value="Water">Water/Drainage</option>
                    <option value="Parks">Parks & Recreation</option>
                    <option value="Waste">Waste Management</option>
                    <option value="Other">Other</option>
                </select>
                <select id="admin-votes-filter" onchange="adminDashboard.applyFiltersFromControls()">
                    <option value="">All Votes</option>
                    <option value="0">0 votes</option>
                    <option value="1-5">1â€“5 votes</option>
                    <option value="6-10">6â€“10 votes</option>
                    <option value="11-20">11â€“20 votes</option>
                    <option value="20+">20+ votes</option>
                </select>
            </div>
        </div>

        <!-- Issues Management Table -->
        <div class="issues-table">
            <div class="table-header">
                <h3>Issue Management</h3>
            </div>
            <div id="issues-container">
                <div id="loading-issues" class="loading">Loading issues...</div>
            </div>
        </div>
    </main>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Profile</h3>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-section">
                        <h4>Personal Information</h4>
                        <div class="profile-form-grid">
                            <div class="form-group">
                                <label for="profile-full-name">Username</label>
                                <input type="text" id="profile-full-name" name="full_name" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-email">Email Address</label>
                                <input type="email" id="profile-email" name="email" readonly>
                                <small>Email cannot be changed</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" name="phone" placeholder="Enter your phone number">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Location Information</h4>
                        <div class="profile-form-grid">
                            <div class="form-group">
                                <label for="profile-province">Province</label>
                                <input type="text" id="profile-province" name="province" readonly value="Eastern">
                                <small>Province cannot be changed</small>
                            </div>
                            <div class="form-group">
                                <label for="profile-district">District</label>
                                <input type="text" id="profile-district" name="district" readonly>
                                <small>District cannot be changed</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="closeProfileModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Update Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Issue Details Modal -->
    <div id="issue-details-modal" class="modal" style="display: none;">
        <div class="modal-content issue-details-content">
            <div class="modal-header">
                <h3 id="issue-title">Issue Details</h3>
                <span class="close" onclick="closeIssueDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Issue Information Section -->
                <section class="issue-info-section">
                    <div class="issue-basic-info">
                        <h4 id="issue-details-title">Loading...</h4>
                        <p id="issue-details-description">Loading description...</p>
                        
                        <!-- Basic Info Grid -->
                        <div class="issue-meta">
                            <p><strong>Reporter:</strong> <span id="issue-details-reporter">Loading...</span></p>
                            <p><strong>Reported Date:</strong> <span id="issue-details-date">Loading...</span></p>
                            <p><strong>Category:</strong> <span id="issue-details-category">Loading...</span></p>
                            <p><strong>Current Status:</strong> <span id="issue-details-current-status">Loading...</span></p>
                        </div>
                        
                        <!-- Detailed Location Section -->
                        <div class="location-details">
                            <h5>Location Information</h5>
                            <div class="location-grid">
                                <div class="location-admin">
                                    <h6>Administrative Location</h6>
                                    <p><strong>Province:</strong> <span id="issue-details-province">Loading...</span></p>
                                    <p><strong>District:</strong> <span id="issue-details-district">Loading...</span></p>
                                    <p><strong>Sector:</strong> <span id="issue-details-sector">Loading...</span></p>
                                </div>
                                <div class="location-specific">
                                    <h6>Specific Location</h6>
                                    <p><strong>Street Address:</strong> <span id="issue-details-street">Loading...</span></p>
                                    <p><strong>Landmark Reference:</strong> <span id="issue-details-landmark">Loading...</span></p>
                                </div>
                            </div>
                            <div class="location-description">
                                <h6>Detailed Location Description</h6>
                                <p id="issue-details-location-desc">Loading...</p>
                            </div>
                        </div>
                        
                        <!-- Photo Documentation -->
                        <div class="photo-section" id="photo-section" style="display: none;">
                            <h5>Photo Documentation</h5>
                            <div class="photo-container">
                                <img id="issue-photo" src="" alt="Issue Photo" class="issue-photo">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Admin Action Section -->
                <section class="admin-action-section">
                    <h5>Take Action</h5>
                    <div class="action-form">
                        <div class="form-group">
                            <label for="status-select">Update Status:</label>
                            <select id="status-select" class="status-dropdown">
                                <option value="open">Open</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="admin-comment">What action did you take?</label>
                            <textarea id="admin-comment" class="admin-comment-input" 
                                    placeholder="e.g., 'Contacted maintenance team, scheduled for tomorrow'" 
                                    rows="3"></textarea>
                        </div>
                        
                        <button id="save-status-btn" class="btn-save-status" onclick="saveStatusUpdate()">
                            Save Changes
                        </button>
                    </div>
                </section>

                <!-- Status Timeline Section -->
                <section class="timeline-section">
                    <h5>Progress Timeline</h5>
                    <div id="status-timeline" class="timeline-container">
                        <div class="timeline-loading">Loading timeline...</div>
                    </div>
                </section>

                <!-- Admin Comments Section -->
                <section class="comments-section">
                    <h5>Admin Notes History</h5>
                    <div id="admin-comments-list" class="comments-container">
                        <div class="comments-loading">Loading comments...</div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script src="notifications.js"></script>
    <script src="websocket.js"></script>
    <script>
        // API configuration
        const API_BASE_URL = 'https://civicfix-cwz8.onrender.com';
        
        class AdminDashboard {
            constructor() {
                this.issues = [];
                this.currentFilter = 'all';
                this.adminToken = localStorage.getItem('admin_token');
                this.adminUser = JSON.parse(localStorage.getItem('admin_user') || '{}');
                this.totalIssues = 0;
                this.adminDistrict = '';
                this.autoRefreshInterval = null;
                this.autoRefreshEnabled = true;
                this.refreshIntervalSeconds = 30; // Auto-refresh every 30 seconds
                // Admin-side filters for status, category and vote ranges
                this.filters = { status: '', category: '', votes: '' };
                
                if (!this.adminToken) {
                    window.location.href = '/admin-login.html';
                    return;
                }
                

                this.setupEventListeners();
                this.displayAdminInfo();
                this.loadIssues();
                // Real-time updates are now handled by the shared WebSocketManager
                // defined in websocket.js, so we no longer need a second
                // WebSocket connection here.
                this.startAutoRefresh();
                
                // Debug: Log initialization
                console.log('AdminDashboard initialized');
                console.log('Admin token:', this.adminToken ? 'Present' : 'Missing');
                console.log('Admin user:', this.adminUser);
            }

            setupEventListeners() {
                document.getElementById('admin-logout-btn').addEventListener('click', () => {
                    this.logout();
                });
                
                document.getElementById('profile-btn').addEventListener('click', () => {
                    this.openProfileModal();
                });
                
                document.getElementById('profile-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateProfile();
                });
            }

            displayAdminInfo() {
                const adminInfoEl = document.getElementById('admin-info');
                // Try to get full name from localStorage, fallback to username or email
                const fullName = localStorage.getItem('admin_full_name') || 
                                this.adminUser.username || 
                                this.adminUser.email?.split('@')[0] || 
                                'Admin';
                adminInfoEl.textContent = `Welcome, ${fullName}`;
            }

            async loadIssues(isAutoRefresh = false) {
                try {
                    if (!isAutoRefresh) {
                        console.log('Loading issues for admin...');
                    } else {
                        console.log('Auto-refreshing issues...');
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/api/admin/issues`, {
                        headers: {
                            'Authorization': `Bearer ${this.adminToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Issues loaded:', data);
                        
                        // Store the issues array and metadata
                        this.issues = data.issues || [];
                        this.totalIssues = data.total || 0;
                        this.adminDistrict = data.admin_district;
                        
                        this.updateStatistics();
                        this.displayIssues();
                        
                        showSuccess(`Loaded ${this.issues.length} issues for ${this.adminDistrict} district`);
                    } else {
                        const errorData = await response.json();
                        console.error('Failed to load issues:', errorData);
                        showError(errorData.error || 'Failed to load issues. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('Error loading issues:', error);
                    showError('Network error loading issues. Please check your connection.');
                    
                    // Hide loading indicator even on error
                    const loadingEl = document.getElementById('loading-issues');
                    if (loadingEl) loadingEl.style.display = 'none';
                    
                    // Show error message in the container
                    const container = document.getElementById('issues-container');
                    if (container) {
                        container.innerHTML = '<div class="loading" style="color: #e53e3e;">Failed to load issues. Please refresh the page.</div>';
                    }
                }
            }

            updateStatistics() {
                console.log('Updating statistics...');
                console.log('Issues data:', this.issues);
                
                const total = this.issues.length;
                
                // Debug: Show all status values
                const statusValues = this.issues.map(issue => issue.status);
                console.log('All status values:', statusValues);
                
                const open = this.issues.filter(issue => {
                    const status = (issue.status || '').toLowerCase();
                    const isOpen = status === 'open';
                    if (isOpen) console.log(`Open issue found: ${issue.title} (status: "${issue.status}")`);
                    return isOpen;
                }).length;
                
                const inProgress = this.issues.filter(issue => {
                    const status = (issue.status || '').toLowerCase();
                    const isInProgress = status === 'in-progress';
                    if (isInProgress) console.log(`In-progress issue found: ${issue.title} (status: "${issue.status}")`);
                    return isInProgress;
                }).length;
                
                const resolved = this.issues.filter(issue => {
                    const status = (issue.status || '').toLowerCase();
                    const isResolved = status === 'resolved';
                    if (isResolved) console.log(`Resolved issue found: ${issue.title} (status: "${issue.status}")`);
                    return isResolved;
                }).length;

                console.log(`ðŸ“ˆ Statistics: Total=${total}, Open=${open}, In-Progress=${inProgress}, Resolved=${resolved}`);

                // Update the display
                document.getElementById('total-issues').textContent = total;
                document.getElementById('open-issues').textContent = open;
                document.getElementById('in-progress-issues').textContent = inProgress;
                document.getElementById('resolved-issues').textContent = resolved;
                
                // Verify the math adds up
                const sum = open + inProgress + resolved;
                if (sum !== total) {
                    console.warn(`Statistics don't add up! Total=${total}, Sum of parts=${sum}`);
                    console.warn('This might indicate issues with status values or filtering logic');
                }
            }

            displayIssues() {
                const container = document.getElementById('issues-container');
                const loadingEl = document.getElementById('loading-issues');
                
                if (loadingEl) loadingEl.style.display = 'none';

                if (this.issues.length === 0) {
                    container.innerHTML = '<div class="loading">No issues found.</div>';
                    return;
                }

                // 1) Filter according to the active tab
                let filteredIssues = [...this.issues];
                if (this.currentFilter === 'urgent') {
                    // Urgent view: show only unresolved issues with high vote counts,
                    // sorted by votes (desc), then by reported date (oldest first when votes tie).
                    const URGENT_MIN_VOTES = 11; // define "high" support
                    filteredIssues = filteredIssues
                        .filter(issue => (issue.status || '').toLowerCase() !== 'resolved')
                        .filter(issue => (issue.vote_count || 0) >= URGENT_MIN_VOTES);
                    filteredIssues.sort((a, b) => {
                        const votesA = a.vote_count || 0;
                        const votesB = b.vote_count || 0;
                        if (votesB !== votesA) return votesB - votesA; // more votes first
                        // If same votes, older reports first
                        return new Date(a.created_at) - new Date(b.created_at);
                    });
                } else {
                    // "All issues" view: order purely by reported date (newest first)
                    filteredIssues.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                }

                // 1.5) Apply manual filters (status / category / votes)
                filteredIssues = this.applyManualFilters(filteredIssues);

                // 2) Render the table rows
                container.innerHTML = `
                    <div class="issues-table-header">
                        <div style="flex: 3;">Issue Details</div>
                        <div style="flex: 1; text-align: center;">Status</div>
                        <div style="flex: 1; text-align: center;">Priority</div>
                        <div style="flex: 1; text-align: center;">Votes</div>
                        <div style="flex: 1; text-align: center;">Actions</div>
                    </div>
                ` + filteredIssues.map(issue => `
                    <div class="issue-row" data-issue-id="${issue.id}">
                        <div style="flex: 3;">
                            <strong>${issue.title}</strong>
                            <br>
                            <small style="color: #718096;">${issue.description.substring(0, 100)}...</small>
                            <br>
                            <small style="color: #4a5568;">Location provided</small>
                            <br>
                            <small style="color: #2d3748;">Reported by: ${issue.reporter_name || 'Anonymous'}</small>
                            <br>
                            <small style="color: #2d3748;">Category: ${issue.category || 'General'}</small>
                            <br>
                            <small style="color: #2d3748;">Reported at: ${new Date(issue.created_at).toLocaleDateString()}</small>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <span class="status ${issue.status}">${issue.status.replace('-', ' ').toUpperCase()}</span>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <span class="priority-badge ${this.getPriorityClass(issue)}">
                                ${this.getPriorityText(issue)}
                            </span>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <strong>${issue.vote_count || 0}</strong>
                            <br>
                            <small>votes</small>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <select onchange="adminDashboard.updateIssueStatus(${issue.id}, this.value)" 
                                    style="margin-bottom: 0.5rem; padding: 0.25rem; border-radius: 4px; width: 90%;">
                                <option value="open" ${issue.status === 'open' ? 'selected' : ''}>Open</option>
                                <option value="in-progress" ${issue.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                <option value="resolved" ${issue.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                            </select>
                            <br>
                            <button onclick="viewIssueDetails(${issue.id})" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer;">
                                View Details
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            applyManualFilters(issues) {
                if (!Array.isArray(issues) || !this.filters) {
                    return issues;
                }

                let result = [...issues];

                const statusFilter = (this.filters.status || '').toLowerCase();
                const categoryFilter = (this.filters.category || '').toLowerCase();
                const votesFilter = this.filters.votes || '';

                if (statusFilter) {
                    result = result.filter(issue => (issue.status || '').toLowerCase() === statusFilter);
                }

                if (categoryFilter) {
                    result = result.filter(issue => (issue.category || '').toLowerCase() === categoryFilter);
                }

                if (votesFilter) {
                    let min = 0;
                    let max = Infinity;
                    switch (votesFilter) {
                        case '0':
                            min = 0; max = 0; break;
                        case '1-5':
                            min = 1; max = 5; break;
                        case '6-10':
                            min = 6; max = 10; break;
                        case '11-20':
                            min = 11; max = 20; break;
                        case '20+':
                            min = 20; max = Infinity; break;
                        default:
                            min = 0; max = Infinity; break;
                    }

                    result = result.filter(issue => {
                        const votes = issue.vote_count || 0;
                        return votes >= min && votes <= max;
                    });
                }

                return result;
            }

            applyFiltersFromControls() {
                // Read values from the three admin filter controls and refresh the table
                const statusSelect = document.getElementById('admin-status-filter');
                const categorySelect = document.getElementById('admin-category-filter');
                const votesSelect = document.getElementById('admin-votes-filter');

                this.filters.status = statusSelect ? statusSelect.value : '';
                this.filters.category = categorySelect ? categorySelect.value : '';
                this.filters.votes = votesSelect ? votesSelect.value : '';

                // When admin changes filters manually, switch back to the full "All" view
                this.currentFilter = 'all';
                this.displayIssues();
            }

            getPriorityClass(issue) {
                if (issue.vote_count > 10) return 'priority-high';
                if (issue.vote_count > 3) return 'priority-medium';
                return 'priority-low';
            }

            getPriorityText(issue) {
                if (issue.vote_count > 10) return 'HIGH';
                if (issue.vote_count > 3) return 'MEDIUM';
                return 'LOW';
            }

            async updateIssueStatus(issueId, newStatus) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/issues/${issueId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.adminToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        showSuccess(`Issue status updated to ${newStatus.replace('-', ' ')}`);
                        this.loadIssues(); // Refresh the list
                    } else {
                        showError('Failed to update issue status');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    showError('Network error updating status');
                }
            }

            viewIssueDetails(issueId) {
                const issue = this.issues.find(i => i.id === issueId);
                if (issue) {
                    // Create a detailed view modal or redirect
                    alert(`Issue Details:\n\nTitle: ${issue.title}\nDescription: ${issue.description}\nLocation: ${issue.location_address || 'See location details'}\nVotes: ${issue.vote_count}\nStatus: ${issue.status}\nReported: ${new Date(issue.created_at).toLocaleString()}`);
                }
            }

            setupWebSocket() {
                // Connect to WebSocket for real-time updates
                if (typeof WebSocketManager !== 'undefined') {
                    const wsManager = new WebSocketManager();
                    wsManager.connect();
                    
                    // Listen for new issues
                    wsManager.socket.on('new_issue', (data) => {
                        showInfo(`New issue reported: ${data.title}`);
                        this.loadIssues(); // Refresh the dashboard
                    });
                }
            }

            openProfileModal() {
                // Populate form with current user data
                document.getElementById('profile-full-name').value = localStorage.getItem('admin_full_name') || this.adminUser.username || '';
                document.getElementById('profile-email').value = this.adminUser.email || '';
                document.getElementById('profile-phone').value = this.adminUser.phone || '';
                document.getElementById('profile-district').value = this.adminUser.district || '';
                document.getElementById('profile-province').value = this.adminUser.province || 'Eastern';
                
                // Show modal
                document.getElementById('profile-modal').style.display = 'block';
            }
            
            async updateProfile() {
                const fullName = document.getElementById('profile-full-name').value;
                const phone = document.getElementById('profile-phone').value;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.adminToken}`
                        },
                        body: JSON.stringify({
                            full_name: fullName,
                            phone: phone
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Update localStorage
                        localStorage.setItem('admin_full_name', fullName);
                        
                        // Update displayed name
                        this.displayAdminInfo();
                        
                        showSuccess('Profile updated successfully!');
                        this.closeProfileModal();
                    } else {
                        showError(data.error || 'Failed to update profile');
                    }
                } catch (error) {
                    console.error('Profile update error:', error);
                    showError('Network error. Please try again.');
                }
            }
            
            closeProfileModal() {
                document.getElementById('profile-modal').style.display = 'none';
            }

            logout() {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                localStorage.removeItem('admin_full_name');
                showInfo('Logged out successfully');
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 1000);
            }

            // Auto-refresh functionality
            startAutoRefresh() {
                if (!this.autoRefreshEnabled) return;
                
                console.log(`Auto-refresh started: every ${this.refreshIntervalSeconds} seconds`);
                
                this.autoRefreshInterval = setInterval(() => {
                    console.log('Auto-refreshing dashboard...');
                    this.loadIssues(true); // Pass true to indicate this is an auto-refresh
                }, this.refreshIntervalSeconds * 1000);
                
                // Add visual indicator
                this.addAutoRefreshIndicator();
            }

            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                    console.log('Auto-refresh stopped');
                }
                this.removeAutoRefreshIndicator();
            }

            toggleAutoRefresh() {
                this.autoRefreshEnabled = !this.autoRefreshEnabled;
                
                const toggleButton = document.getElementById('auto-refresh-toggle');
                
                if (this.autoRefreshEnabled) {
                    this.startAutoRefresh();
                    showSuccess('Auto-refresh enabled - Dashboard will update every 30 seconds');
                    if (toggleButton) {
                        toggleButton.innerHTML = 'Auto-Refresh ON';
                        toggleButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    }
                } else {
                    this.stopAutoRefresh();
                    showInfo('Auto-refresh disabled');
                    if (toggleButton) {
                        toggleButton.innerHTML = 'Auto-Refresh OFF';
                        toggleButton.style.background = 'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)';
                    }
                }
            }

            addAutoRefreshIndicator() {
                // Add a small indicator to show auto-refresh is active
                if (!document.getElementById('auto-refresh-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.id = 'auto-refresh-indicator';
                    indicator.innerHTML = `
                        <div style="
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: rgba(102, 126, 234, 0.9);
                            color: white;
                            padding: 8px 12px;
                            border-radius: 20px;
                            font-size: 0.8rem;
                            z-index: 1000;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        ">
                            <div class="refresh-pulse" style="
                                width: 8px;
                                height: 8px;
                                background: #4ade80;
                                border-radius: 50%;
                                animation: pulse 2s infinite;
                            "></div>
                            Auto-refresh ON
                            <button onclick="adminDashboard.toggleAutoRefresh()" style="
                                background: none;
                                border: none;
                                color: white;
                                cursor: pointer;
                                font-size: 1rem;
                                padding: 0;
                                margin-left: 4px;
                            ">Ã—</button>
                        </div>
                        <style>
                            @keyframes pulse {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.5; }
                            }
                        </style>
                    `;
                    document.body.appendChild(indicator);
                }
            }

            removeAutoRefreshIndicator() {
                const indicator = document.getElementById('auto-refresh-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }

        // Global variables for issue details modal
        let currentIssueId = null;
        let currentIssueData = null;

        // Global functions for issue details modal
        async function viewIssueDetails(issueId) {
            try {
                currentIssueId = issueId;
                
                // Show modal with loading state
                document.getElementById('issue-details-modal').style.display = 'block';
                
                // Fetch issue details from backend
                const adminToken = localStorage.getItem('admin_token');
                const response = await fetch(`${API_BASE_URL}/api/admin/issues/${issueId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentIssueData = data.issue;
                    
                    // Populate modal with issue data
                    populateIssueModal(data.issue);
                    
                } else {
                    const errorData = await response.json();
                    showError(errorData.error || 'Failed to load issue details');
                    closeIssueDetailsModal();
                }
            } catch (error) {
                console.error('Error loading issue details:', error);
                showError('Network error loading issue details');
                closeIssueDetailsModal();
            }
        }

        function populateIssueModal(issue) {
            // Basic issue information
            document.getElementById('issue-details-title').textContent = issue.title;
            document.getElementById('issue-details-description').textContent = issue.description;
            document.getElementById('issue-details-category').textContent = issue.category || 'General';
            document.getElementById('issue-details-date').textContent = new Date(issue.created_at).toLocaleDateString();
            document.getElementById('issue-details-current-status').textContent = issue.status || 'Open';
            
            // Reporter information
            if (issue.reporter) {
                document.getElementById('issue-details-reporter').textContent = 
                    `${issue.reporter.name} (${issue.reporter.phone || 'No phone'})`;
            } else {
                document.getElementById('issue-details-reporter').textContent = 'Anonymous';
            }
            
            // Administrative location
            document.getElementById('issue-details-province').textContent = issue.province || 'Not specified';
            document.getElementById('issue-details-district').textContent = issue.district || 'Not specified';
            document.getElementById('issue-details-sector').textContent = issue.sector || 'Not specified';
            
            // Specific location
            document.getElementById('issue-details-street').textContent = issue.street_address || 'Not provided';
            document.getElementById('issue-details-landmark').textContent = issue.landmark_reference || 'Not provided';
            
            // Detailed location description
            const locationDesc = issue.detailed_description || 'No detailed location description provided';
            document.getElementById('issue-details-location-desc').textContent = locationDesc;
            
            // Photo documentation
            const photoSection = document.getElementById('photo-section');
            const issuePhoto = document.getElementById('issue-photo');
            
            if (issue.image_url) {
                photoSection.style.display = 'block';
                issuePhoto.src = `${API_BASE_URL}${issue.image_url}`;
                issuePhoto.onclick = () => window.open(issuePhoto.src, '_blank');
            } else {
                photoSection.style.display = 'none';
            }
            
            // Set current status in dropdown
            document.getElementById('status-select').value = issue.status;
            
            // Clear comment input
            document.getElementById('admin-comment').value = '';
            
            // Populate timeline
            populateTimeline(issue.status_history || []);
            
            // Populate comments
            populateComments(issue.admin_comments || []);
        }

        function populateTimeline(statusHistory) {
            const timelineContainer = document.getElementById('status-timeline');
            
            if (statusHistory.length === 0) {
                timelineContainer.innerHTML = '<div class="timeline-loading">No status changes yet</div>';
                return;
            }
            
                    const timelineHTML = statusHistory.map(history => {
                const date = new Date(history.changed_at).toLocaleString();
                const statusChange = history.old_status 
                    ? `Status changed from "${history.old_status}" to "${history.new_status}"`
                    : `Issue created (Status: ${history.new_status})`;
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-date">${date}</div>
                        <div class="timeline-action">${statusChange} by ${history.changed_by}</div>
                        ${history.admin_comment ? `<div class="timeline-comment">"${history.admin_comment}"</div>` : ''}
                    </div>
                `;
            }).join('');
            
            timelineContainer.innerHTML = timelineHTML;
        }

        function populateComments(adminComments) {
            const commentsContainer = document.getElementById('admin-comments-list');
            
            if (adminComments.length === 0) {
                commentsContainer.innerHTML = '<div class="comments-loading">No admin notes yet</div>';
                return;
            }
            
            const commentsHTML = adminComments.map(comment => {
                const date = new Date(comment.created_at).toLocaleString();
                
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">${comment.admin_name}</span>
                            <span class="comment-date">${date}</span>
                        </div>
                        <div class="comment-text">${comment.comment}</div>
                    </div>
                `;
            }).join('');
            
            commentsContainer.innerHTML = commentsHTML;
        }

        async function saveStatusUpdate() {
            try {
                const newStatus = document.getElementById('status-select').value;
                const adminComment = document.getElementById('admin-comment').value.trim();
                
                if (!adminComment) {
                    showError('Please provide a comment explaining what action you took');
                    return;
                }
                
                // Show loading state
                const saveButton = document.getElementById('save-status-btn');
                const originalText = saveButton.textContent;
                saveButton.textContent = 'Saving...';
                saveButton.disabled = true;
                
                // Send update to backend
                const adminToken = localStorage.getItem('admin_token');
                const response = await fetch(`${API_BASE_URL}/api/admin/issues/${currentIssueId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        comment: adminComment
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Store the current issue ID and new status for updating
                    const issueIdToUpdate = currentIssueId;
                    const statusToUpdate = newStatus;
                    
                    console.log(`=== STARTING STATUS UPDATE PROCESS ===`);
                    console.log(`Issue ID: ${issueIdToUpdate}, New Status: ${statusToUpdate}`);
                    
                    // Close the modal and return to dashboard first
                    closeIssueDetailsModal();
                    
                    // Update immediately after modal closes
                    setTimeout(() => {
                        console.log(`=== ATTEMPTING IMMEDIATE UPDATE ===`);
                        updateIssueStatusInTable(issueIdToUpdate, statusToUpdate);
                        
                        // Verify the update worked after a short delay
                        setTimeout(() => {
                            console.log(`=== VERIFYING UPDATE RESULTS ===`);
                            const issueRow = document.querySelector(`[data-issue-id="${issueIdToUpdate}"]`);
                            if (issueRow) {
                                const statusSpan = issueRow.querySelector('.status');
                                const statusSelect = issueRow.querySelector('select');
                                
                                console.log(`Status span text: "${statusSpan ? statusSpan.textContent : 'NOT FOUND'}"`);
                                console.log(`Dropdown value: "${statusSelect ? statusSelect.value : 'NOT FOUND'}"`);
                                
                                // Force update if they don't match
                                if (statusSpan && !statusSpan.textContent.toLowerCase().includes(statusToUpdate.replace('-', ' '))) {
                                    console.log('FORCING STATUS SPAN UPDATE');
                                    statusSpan.textContent = statusToUpdate.replace('-', ' ').toUpperCase();
                                    statusSpan.className = `status ${statusToUpdate}`;
                                }
                                
                                if (statusSelect && statusSelect.value !== statusToUpdate) {
                                    console.log('FORCING DROPDOWN UPDATE');
                                    statusSelect.value = statusToUpdate;
                                    
                                    // Update all options
                                    const options = statusSelect.querySelectorAll('option');
                                    options.forEach(option => {
                                        option.selected = (option.value === statusToUpdate);
                                    });
                                }
                            }
                        }, 300);
                    }, 50);
                    
                    // Show success message after modal closes
                    showSuccess(`Issue status updated to "${newStatus.toUpperCase()}" successfully!`);
                    
                    // Update statistics counters immediately
                    // Get old status from the current status badge in the table
                    const issueRow = document.querySelector(`[data-issue-id="${currentIssueId}"]`);
                    let oldStatus = null;
                    
                    if (issueRow) {
                        const statusBadge = issueRow.querySelector('.status');
                        if (statusBadge) {
                            const badgeText = statusBadge.textContent.toLowerCase().trim();
                            if (badgeText === 'in progress') oldStatus = 'in-progress';
                            else if (badgeText === 'open') oldStatus = 'open';
                            else if (badgeText === 'resolved') oldStatus = 'resolved';
                        }
                    }
                    
                    // Fallback to currentIssueData if available
                    if (!oldStatus && currentIssueData) {
                        oldStatus = currentIssueData.status;
                    }
                    
                    console.log(`Status change: "${oldStatus}" â†’ "${newStatus}"`);
                    updateStatisticsAfterStatusChange(oldStatus, newStatus);
                    
                    // Delay the background refresh to avoid overriding our immediate updates
                    setTimeout(() => {
                        console.log(`=== BACKGROUND REFRESH (DELAYED) ===`);
                        if (window.adminDashboard) {
                            window.adminDashboard.loadIssues().then(() => {
                                // Recalculate statistics after refresh to ensure accuracy
                                setTimeout(() => {
                                    recalculateStatistics();
                                }, 100);
                            });
                        }
                    }, 2000); // Wait 2 seconds before background refresh
                    
                } else {
                    const errorData = await response.json();
                    showError(errorData.error || 'Failed to update issue');
                }
                
            } catch (error) {
                console.error('Error updating issue:', error);
                showError('Network error updating issue');
            } finally {
                // Reset button state
                const saveButton = document.getElementById('save-status-btn');
                saveButton.textContent = 'Save Changes';
                saveButton.disabled = false;
            }
        }

        function updateIssueStatusInTable(issueId, newStatus) {
            console.log(`updateIssueStatusInTable: Issue ${issueId} â†’ ${newStatus}`);
            
            // Find the specific issue row using the data attribute
            const issueRow = document.querySelector(`[data-issue-id="${issueId}"]`);
            
            if (!issueRow) {
                console.error(`Issue row not found for ID ${issueId}`);
                // Debug: show all available rows
                const allRows = document.querySelectorAll('[data-issue-id]');
                console.log(`Available rows: ${Array.from(allRows).map(r => r.getAttribute('data-issue-id')).join(', ')}`);
                return false;
            }
            
            console.log(`Found issue row for ID ${issueId}`);
            
            // Update Status Badge (Status Column)
            const statusSpan = issueRow.querySelector('.status');
            if (statusSpan) {
                const oldText = statusSpan.textContent;
                const newText = newStatus.replace('-', ' ').toUpperCase();
                console.log(`Status badge: "${oldText}" â†’ "${newText}"`);
                
                statusSpan.textContent = newText;
                statusSpan.className = `status ${newStatus}`;
                
                // Visual feedback
                statusSpan.style.backgroundColor = '#ffeb3b';
                setTimeout(() => {
                    statusSpan.style.backgroundColor = '';
                }, 500);
                
                console.log(`Status badge updated successfully`);
            } else {
                console.error(`Status badge (.status) not found in row`);
            }
            
            // Update Actions Dropdown
            const statusSelect = issueRow.querySelector('select');
            if (statusSelect) {
                const oldValue = statusSelect.value;
                console.log(`Dropdown: "${oldValue}" â†’ "${newStatus}"`);
                
                // Method 1: Direct value assignment
                statusSelect.value = newStatus;
                
                // Method 2: Update option selected attributes
                const options = statusSelect.querySelectorAll('option');
                options.forEach(option => {
                    option.selected = (option.value === newStatus);
                    if (option.value === newStatus) {
                        option.setAttribute('selected', 'selected');
                    } else {
                        option.removeAttribute('selected');
                    }
                });
                
                // Method 3: Force recreation if needed
                if (statusSelect.value !== newStatus) {
                    console.log(`ðŸ”§ Forcing dropdown recreation`);
                    statusSelect.innerHTML = `
                        <option value="open" ${newStatus === 'open' ? 'selected' : ''}>Open</option>
                        <option value="in-progress" ${newStatus === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="resolved" ${newStatus === 'resolved' ? 'selected' : ''}>Resolved</option>
                    `;
                    statusSelect.value = newStatus;
                }
                
                // Visual feedback
                statusSelect.style.border = '2px solid #4caf50';
                setTimeout(() => {
                    statusSelect.style.border = '';
                }, 500);
                
                console.log(`Dropdown updated: final value = "${statusSelect.value}"`);
            } else {
                console.error(`Status dropdown (select) not found in row`);
            }
            
            return true;
        }

        function updateStatisticsAfterStatusChange(oldStatus, newStatus) {
            console.log(`Updating statistics: "${oldStatus}" â†’ "${newStatus}"`);
            
            // Validate inputs
            if (!newStatus) {
                console.error('New status is required');
                return;
            }
            
            if (!oldStatus) {
                console.warn('Old status is null/undefined - this may cause inaccurate counts');
            }
            
            // Get current statistics elements
            const totalElement = document.getElementById('total-issues');
            const openElement = document.getElementById('open-issues');
            const progressElement = document.getElementById('in-progress-issues');
            const resolvedElement = document.getElementById('resolved-issues');
            
            if (!totalElement || !openElement || !progressElement || !resolvedElement) {
                console.error('Statistics elements not found');
                return;
            }
            
            // Get current counts
            let total = parseInt(totalElement.textContent) || 0;
            let open = parseInt(openElement.textContent) || 0;
            let inProgress = parseInt(progressElement.textContent) || 0;
            let resolved = parseInt(resolvedElement.textContent) || 0;
            
            console.log(`BEFORE: Total=${total}, Open=${open}, InProgress=${inProgress}, Resolved=${resolved}`);
            
            // Decrease old status count (only if we know the old status)
            if (oldStatus) {
                if (oldStatus === 'open') {
                    open--;
                    console.log(`Decreased Open: ${open + 1} â†’ ${open}`);
                } else if (oldStatus === 'in-progress') {
                    inProgress--;
                    console.log(`Decreased InProgress: ${inProgress + 1} â†’ ${inProgress}`);
                } else if (oldStatus === 'resolved') {
                    resolved--;
                    console.log(`Decreased Resolved: ${resolved + 1} â†’ ${resolved}`);
                }
            } else {
                console.warn('Skipping old status decrease - old status unknown');
            }
            
            // Increase new status count
            if (newStatus === 'open') {
                open++;
                console.log(`Increased Open: ${open - 1} â†’ ${open}`);
            } else if (newStatus === 'in-progress') {
                inProgress++;
                console.log(`Increased InProgress: ${inProgress - 1} â†’ ${inProgress}`);
            } else if (newStatus === 'resolved') {
                resolved++;
                console.log(`Increased Resolved: ${resolved - 1} â†’ ${resolved}`);
            }
            
            // Ensure counts don't go negative
            open = Math.max(0, open);
            inProgress = Math.max(0, inProgress);
            resolved = Math.max(0, resolved);
            
            console.log(`AFTER: Total=${total}, Open=${open}, InProgress=${inProgress}, Resolved=${resolved}`);
            
            // Update the display with visual feedback
            totalElement.textContent = total;
            openElement.textContent = open;
            progressElement.textContent = inProgress;
            resolvedElement.textContent = resolved;
            
            // Add visual feedback - briefly highlight the changed counter
            let changedElement = null;
            if (newStatus === 'open') changedElement = openElement;
            else if (newStatus === 'in-progress') changedElement = progressElement;
            else if (newStatus === 'resolved') changedElement = resolvedElement;
            
            if (changedElement) {
                changedElement.style.transform = 'scale(1.1)';
                changedElement.style.transition = 'transform 0.3s ease';
                setTimeout(() => {
                    changedElement.style.transform = '';
                }, 300);
            }
            
            console.log('Statistics updated successfully');
        }

        // Force recalculate statistics from actual issue data
        function recalculateStatistics() {
            console.log('Recalculating statistics from actual issue data...');
            
            if (!window.adminDashboard || !window.adminDashboard.issues) {
                console.warn('No issue data available for recalculation');
                return;
            }
            
            const issues = window.adminDashboard.issues;
            const total = issues.length;
            
            let open = 0, inProgress = 0, resolved = 0;
            
            issues.forEach(issue => {
                const status = (issue.status || '').toLowerCase();
                if (status === 'open') open++;
                else if (status === 'in-progress') inProgress++;
                else if (status === 'resolved') resolved++;
            });
            
            console.log(`Recalculated: Total=${total}, Open=${open}, InProgress=${inProgress}, Resolved=${resolved}`);
            
            // Update the display
            const totalElement = document.getElementById('total-issues');
            const openElement = document.getElementById('open-issues');
            const progressElement = document.getElementById('in-progress-issues');
            const resolvedElement = document.getElementById('resolved-issues');
            
            if (totalElement) totalElement.textContent = total;
            if (openElement) openElement.textContent = open;
            if (progressElement) progressElement.textContent = inProgress;
            if (resolvedElement) resolvedElement.textContent = resolved;
            
            console.log('Statistics recalculated and updated');
        }

        function closeIssueDetailsModal() {
            document.getElementById('issue-details-modal').style.display = 'none';
            currentIssueId = null;
            currentIssueData = null;
        }

        // Global functions for buttons
        function filterIssues(filter) {
            // Ensure dashboard is initialized before applying filter
            if (!window.adminDashboard) {
                console.warn('AdminDashboard not initialized yet â€“ creating a new instance now.');
                window.adminDashboard = new AdminDashboard();
            }

            window.adminDashboard.currentFilter = filter;
            window.adminDashboard.displayIssues();
        }

        function exportReport() {
            showInfo('Report export feature coming soon!');
        }

        function showNotificationSettings() {
            showInfo('Notification settings coming soon!');
        }
        
        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            window.adminDashboard = new AdminDashboard(); // Make it globally accessible
            
            // Debug function for troubleshooting
            window.debugDashboard = function() {
                console.log('=== DASHBOARD DEBUG INFO ===');
                console.log('Admin token:', localStorage.getItem('admin_token') ? 'Present' : 'Missing');
                console.log('Admin user:', localStorage.getItem('admin_user'));
                console.log('Issues array:', window.adminDashboard.issues);
                console.log('Issues count:', window.adminDashboard.issues.length);
                console.log('Auto-refresh enabled:', window.adminDashboard.autoRefreshEnabled);
                console.log('Auto-refresh interval:', window.adminDashboard.autoRefreshInterval);
                console.log('=== END DEBUG INFO ===');
                
                // Force a manual refresh and recalculate statistics
                console.log('Forcing manual refresh...');
                window.adminDashboard.loadIssues().then(() => {
                    console.log('Recalculating statistics...');
                    recalculateStatistics();
                });
            };
            
            // Add global function for manual statistics recalculation
            window.recalculateStats = recalculateStatistics;
        });
    </script>
</body>
</html>

